name: Step 4 # Merge your pull request

# Checks if the learner completed tasks for step 4.
# - Triggers when the user merges the pull request.
# - If all checks pass, the workflow is disabled so it doesn't run again. As such, workflow status badge will change to green.

on:
  pull_request:
    branches:
      - main
    types:
      - closed

permissions:
  contents: write
  actions: write
  issues: write

jobs:
  check_step_4_work:
    name: Check step 4 work
    runs-on: ubuntu-latest
    if: |
      !github.event.repository.is_template &&
      github.head_ref == 'my-first-branch' &&
      github.event.pull_request.merged == true

    steps:
      - name: Mark lesson finished
        run: |
          message="ðŸŽ‰ðŸŽ‰ðŸŽ‰  Nice work! Everything is perfect! ðŸŽ‰ðŸŽ‰ðŸŽ‰ Now, let's do a quick review!"
          gh issue comment 1 --body "$message" --repo ${{ github.repository }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  post_review_content:
    name: Post review content
    needs: check_step_4_work
    runs-on: ubuntu-latest
    if: |
      !github.event.repository.is_template &&
      github.head_ref == 'my-first-branch' &&
      github.event.pull_request.merged == true
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Add issue comment with review content
        run: |
          # Load review content
          next_step_content=$(cat steps/x-review.md)
          
          # Update image links to be absolute
          target='steps/'
          replacement='https://github.com/${{ github.repository }}/blob/main/steps/'
          next_step_content=$(echo "$next_step_content" | sed "s|$target|$replacement|g")
          
          # Append "?raw=true" to image links
          target='.png'
          replacement='.png?raw=true'
          next_step_content=$(echo "$next_step_content" | sed "s|$target|$replacement|g")
          
          # Add content to issue
          gh issue comment 1  --body "$next_step_content"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  finish_course:
    name: Finish course
    needs: post_review_content
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
      
      - name: Configure Git user
        run: |
          git config user.name github-actions[bot]
          git config user.email github-actions[bot]@users.noreply.github.com

      - name: Add "Congratulations" to README.md
        run: |
          # Load existing README
          orig_readme=$(cat README.md)

          message="â­ï¸ Congratulations! You've completed this lesson! â­ï¸  
          If you would like to practice the steps again, you can retrace your steps below.  
          We won't grade you this time. ðŸ˜‰
          "
          echo "$message $orig_readme" > README.md
          git add README.md
          git commit --message="Congratulations!ðŸŽ‰"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Final message
        run: |
          message="Return to the [repository home](https://github.com/${{ github.repository }}) page to see your progress!"
          gh issue comment 1 --body "$message"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Disable workflow to prevent running again
        run: gh workflow disable "${{github.workflow}}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}